# GATK-DELLY Allele-based Genotyping

This repository provides a Nextflow (DSL2) pipeline for allele-based genotyping of SNP, INDEL, and Structural Variants (SV) using GATK UnifiedGenotyper and DELLY, followed by Beagle imputation. The pipeline genotypes known variant sites across new samples, making it ideal for population-scale variant panel generation.

## Overview

Given a directory of per-sample BAM/BAI files, a reference FASTA, and pre-defined variant sites VCF files, the workflow performs comprehensive allele-based genotyping:

### SNP/INDEL Genotyping (GATK UnifiedGenotyper)

- Genotypes known SNP and INDEL sites using GATK UnifiedGenotyper in genotype-given-alleles mode (`-gt_mode GENOTYPE_GIVEN_ALLELES`)
- Uses interval lists to target specific marker positions
- Formats VCF files, fills missing ALT alleles, and assigns consistent variant IDs. **Note**: When the input sites VCF contains ALT alleles with `*`, GATK UnifiedGenotyper may output these as `.` (missing) in the genotyped VCF. The formatting step aligns the ALT alleles with the input sites VCF to ensure consistency.

### Structural Variant (SV) Genotyping (DELLY)

- Per-sample SV genotyping against known SV sites using DELLY
- Merges per-sample SV genotypes across the cohort
- Assigns consistent variant IDs to SV records

### Cross-Type Imputation (Beagle)

- Concatenates SNP + INDEL + SV into a combined VCF
- Runs Beagle to impute missing genotypes
- Splits the imputed callset back into SNP/INDEL/SV using ID prefixes

## Requirements

The following software must be installed and available in the **system environment ($PATH)** before running the pipeline:

- `nextflow`
- `java` (Java 8 is compatible with GATK 3.7)
- `gatk` (GATK version 3.7)
- `picard`
- `delly`
- `bcftools`
- `samtools`
- `tabix`

**Note**: The executable names are case-sensitive and must exactly match those listed above. 

### Input Files

- **Reference genome**: FASTA format file
- **BAM files**: Per-sample BAM files with corresponding `.bai` index files
- **SNP sites VCF**: Sites-only VCF file containing SNP positions (no sample genotype data)
- **INDEL sites VCF**: Sites-only VCF file containing INDEL positions (no sample genotype data)
- **SV sites BCF**: Sites-only BCF file containing SV positions (generated by Delly, must retain INFO column)
- **SNP intervals file**: Interval list file specifying SNP marker positions for genotyping
- **INDEL intervals file**: Interval list file specifying INDEL marker positions for genotyping

These sites vcf and intervals can be generated via [GAWS-LD_Markers_Discovery#reproduce-of-rice-graphpangenome-gs](https://github.com/GooLey1025/GWAS-LD_Markers-Discovery#reproduce-of-rice-graphpangenome-gs)

## Configuration

All parameters can be provided either via the command line or a Nextflow configuration file. Detailed parameter settings and default values can be found in the header section of `main.nf`.

### Input Parameters

| Parameter | Description | Required/Default |
|-----------|-------------|------------------|
| `--project` | Project name used for output file naming | `cohort` |
| `--bam_glob` | BAM file glob pattern (e.g., `/path/to/*.bam`). Must include directory path and file pattern. Corresponding `.bai` index files must exist | Required |
| `--ref` | Reference genome FASTA file path | Required |
| `--out_dir` | Output directory for all results | `out_dir` |
| `--snp_site_vcf` | SNP sites-only VCF file path | Required |
| `--indel_site_vcf` | INDEL sites-only VCF file path | Required |
| `--sv_sites_vcf` | SV sites-only BCF file path (must retain INFO column from Delly) | Required |
| `--snp_markers_intervals` | Interval list file for SNP genotyping | Required |
| `--indel_markers_intervals` | Interval list file for INDEL genotyping | Required |
| `--gatk_path` | Path to GATK JAR file. Relative paths are automatically converted to absolute paths | `./GenomeAnalysisTK3.7.jar` (in current repository) |
| `--picard_path` | Path to Picard JAR file. Relative paths are automatically converted to absolute paths | `./picard.jar` (in current repository) |
| `--beagle_path` | Path to Beagle JAR file. Relative paths are automatically converted to absolute paths | Required |
| `--java_path` | Java executable path. Relative paths are automatically converted to absolute paths | `/usr/bin/java` |
| `--delly_path` | Delly executable path. Relative paths are automatically converted to absolute paths | `delly` (from $PATH) |
| `--bcftools_path` | bcftools executable path. Relative paths are automatically converted to absolute paths | `bcftools` (from $PATH) |
| `--threads` | Number of threads for GATK UnifiedGenotyper | `48` |
| `--gatk_memory` | Memory allocation for GATK (e.g., `100g`) | `100g` |
| `--beagle_memory` | Memory allocation for Beagle | `300 GB` |
| `--beagle_cpus` | Number of CPUs for Beagle | `64` |

## Command Examples

```bash
nextflow run main.nf \
    --project "705rice" \
    --bam_glob "/path/to/*.bam" \
    --out_dir "results" \
    --ref "reference.fa" \
    --snp_site_vcf "snp.sites.vcf" \
    --indel_site_vcf "indel.sites.vcf" \
    --sv_sites_vcf "sv.sites.bcf" \
    --snp_markers_intervals "snp.intervals" \
    --indel_markers_intervals "indel.intervals" \
    --gatk_path "/path/to/GenomeAnalysisTK3.7.jar" \
    --picard_path "/path/to/picard.jar" \
    --beagle_path "/path/to/beagle.jar" \
    --java_path "/usr/bin/java" \
    --delly_path "/path/to/delly" \
    --bcftools_path "bcftools" \
    --threads 64 \
    --gatk_memory "120g" \
    --beagle_memory "400 GB" \
    --beagle_cpus 80
```

## Output Structure

All outputs are published into structured subfolders under the configured output directory:

- `snp_indel_genotype/` - SNP and INDEL genotyping results
  - `${project}.snp.raw.vcf.gz` - Raw SNP genotypes from GATK UnifiedGenotyper
  - `${project}.snp.format.id.vcf.gz` - Formatted SNP VCF with variant IDs assigned
  - `${project}.indel.raw.vcf.gz` - Raw INDEL genotypes from GATK UnifiedGenotyper
  - `${project}.indel.format.id.vcf.gz` - Formatted INDEL VCF with variant IDs assigned

- `sample_genotype/` - Per-sample SV genotyping results
  - `${sample_id}.geno.bcf` - Per-sample SV genotypes from DELLY

- `sv_genotype/` - Merged SV genotyping results
  - `${project}.sv.id.vcf.gz` - Merged SV genotypes with variant IDs assigned

- **Final output files** (in `out_dir/`):
  - `${project}.snp.indel.sv.vcf` - Concatenated VCF containing all variant types (before imputation)
  - `${project}.snp.indel.sv.impute.vcf.gz` - Imputed VCF containing all variant types
  - `${project}.snp.impute.vcf.gz` - Imputed SNP variants only
  - `${project}.indel.impute.vcf.gz` - Imputed INDEL variants only
  - `${project}.sv.impute.vcf.gz` - Imputed SV variants only


