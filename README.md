# GATK-DELLY Allele-based Genotyping

This repository provides a Nextflow (DSL2) pipeline for allele-based genotyping of SNP, INDEL, and Structural Variants (SV) using GATK UnifiedGenotyper and DELLY, followed by Beagle imputation. The pipeline genotypes known variant sites across new samples, making it ideal for population-scale variant panel generation.

## Overview

Given a directory of per-sample BAM/BAI files, a reference FASTA, and pre-defined variant sites VCF files, the workflow performs comprehensive allele-based genotyping:

### SNP/INDEL Genotyping (GATK UnifiedGenotyper)

- Genotypes known SNP and INDEL sites using GATK UnifiedGenotyper in genotype-given-alleles mode (`-gt_mode GENOTYPE_GIVEN_ALLELES`)
- Uses interval lists to target specific marker positions
- Formats VCF files, fills missing ALT alleles（because for ALT with *, the gatk might output it as ., so need to align with input vcf）, and assigns consistent variant IDs

### Structural Variant (SV) Genotyping (DELLY)

- Per-sample SV genotyping against known SV sites using DELLY
- Merges per-sample SV genotypes across the cohort
- Assigns consistent variant IDs to SV records

### Cross-Type Imputation (Beagle)

- Concatenates SNP + INDEL + SV into a combined VCF
- Runs Beagle to impute missing genotypes
- Splits the imputed callset back into SNP/INDEL/SV using ID prefixes

## Requirements

The following software must be installed and available in the **system environment ($PATH)** before running the pipeline:

- `nextflow`
- `java` (Need to be compatiable with )
- `gatk` (GATK version 3.7)
- `picard`
- `delly`
- `bcftools`
- `samtools`
- `tabix`

**Note**: The executable names are case-sensitive and must exactly match those listed above. Beagle is specified via the `--beagle` parameter (JAR file path) and does not need to be in PATH.

### Input Files

- **Reference genome**: FASTA format file
- **BAM files**: Per-sample BAM files with corresponding `.bai` index files
- **SNP sites VCF**: Sites-only VCF file containing SNP positions (no sample genotype data)
- **INDEL sites VCF**: Sites-only VCF file containing INDEL positions (no sample genotype data)
- **SV sites BCF**: Sites-only BCF file containing SV positions (generated by Delly, must retain INFO column)
- **SNP intervals file**: Interval list file specifying SNP marker positions for genotyping
- **INDEL intervals file**: Interval list file specifying INDEL marker positions for genotyping
- **assign_id.sh script**: Script for assigning variant IDs (located in `scripts/` directory)

## Configuration

All parameters can be provided either via the command line or a Nextflow configuration file. Detailed parameter settings and default values can be found in the header section of `main.nf`.

### Input Parameters

| Parameter | Description | Required/Default |
|-----------|-------------|------------------|
| `--project` | Project name used for output file naming | Required |
| `--bam_glob` | BAM file glob pattern (e.g., `/path/to/*.bam`). Must include directory path and file pattern. Corresponding `.bai` index files must exist | Required |
| `--ref` | Reference genome FASTA file path | Required |
| `--out_dir` | Output directory for all results | Required |
| `--snp_site_vcf` | SNP sites-only VCF file path | Required |
| `--indel_site_vcf` | INDEL sites-only VCF file path | Required |
| `--sv_sites_vcf` | SV sites-only BCF file path (must retain INFO column from Delly) | Required |
| `--snp_markers_intervals` | Interval list file for SNP genotyping | Required |
| `--indel_markers_intervals` | Interval list file for INDEL genotyping | Required |
| `--gatk` | Path to GATK JAR file (e.g., `GenomeAnalysisTK3.7.jar`) | Required |
| `--picard` | Path to Picard JAR file | Required |
| `--beagle` | Path to Beagle JAR file (e.g., `beagle.29Oct24.c8e.jar`) | Required |
| `--assign_id_path` | Path to `assign_id.sh` script | `./scripts/assign_id.sh` |

### Resource Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--threads` | Number of threads for GATK UnifiedGenotyper | `48` |
| `--gatk_memory` | Memory allocation for GATK (e.g., `100g`) | `100g` |
| `--beagle_memory` | Memory allocation for Beagle | `300 GB` |
| `--beagle_cpus` | Number of CPUs for Beagle | `64` |

### Software Path Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--java` | Java executable path | `/usr/bin/java` |
| `--delly` | Delly executable path | `delly` (from PATH) |
| `--bcftools` | bcftools command | `bcftools` |

## Installation

1. Clone or download this repository
2. Ensure all required software is installed and accessible in your PATH
3. Make sure `scripts/assign_id.sh` is executable:
   ```bash
   chmod +x scripts/assign_id.sh
   ```

## Command Examples

### Basic Usage

Run the complete pipeline with parameters specified in `main.nf`:

```bash
nextflow run main.nf
```

### With Custom Parameters

```bash
nextflow run main.nf \
    --project "705rice" \
    --bam_glob "/path/to/bam_dir/*.bam" \
    --out_dir "705rice_genotype" \
    --ref "reference.fa" \
    --snp_site_vcf "snp.sites.vcf" \
    --indel_site_vcf "indel.sites.vcf" \
    --sv_sites_vcf "sv.sites.bcf" \
    --snp_markers_intervals "snp.intervals" \
    --indel_markers_intervals "indel.intervals" \
    --gatk "/path/to/GenomeAnalysisTK3.7.jar" \
    --picard "/path/to/picard.jar" \
    --beagle "/path/to/beagle.29Oct24.c8e.jar"
```

### Custom Resource Allocation

```bash
nextflow run main.nf \
    --project "705rice" \
    --bam_glob "/path/to/*.bam" \
    --out_dir "results" \
    --ref "reference.fa" \
    --snp_site_vcf "snp.sites.vcf" \
    --indel_site_vcf "indel.sites.vcf" \
    --sv_sites_vcf "sv.sites.bcf" \
    --snp_markers_intervals "snp.intervals" \
    --indel_markers_intervals "indel.intervals" \
    --gatk "/path/to/GATK.jar" \
    --picard "/path/to/picard.jar" \
    --beagle "/path/to/beagle.jar" \
    --threads 64 \
    --gatk_memory "120g" \
    --beagle_memory "400 GB" \
    --beagle_cpus 80
```

### Resume Execution

If the pipeline fails or is interrupted, resume from the last successful step:

```bash
nextflow run main.nf -resume [previous parameters...]
```

## Output Structure

All outputs are published into structured subfolders under the configured output directory:

- `snp_indel_genotype/` - SNP and INDEL genotyping results
  - `${project}.snp.raw.vcf.gz` - Raw SNP genotypes from GATK UnifiedGenotyper
  - `${project}.snp.format.id.vcf.gz` - Formatted SNP VCF with variant IDs assigned
  - `${project}.indel.raw.vcf.gz` - Raw INDEL genotypes from GATK UnifiedGenotyper
  - `${project}.indel.format.id.vcf.gz` - Formatted INDEL VCF with variant IDs assigned

- `sample_genotype/` - Per-sample SV genotyping results
  - `${sample_id}.geno.bcf` - Per-sample SV genotypes from DELLY

- `sv_genotype/` - Merged SV genotyping results
  - `${project}.sv.id.vcf.gz` - Merged SV genotypes with variant IDs assigned

- **Final output files** (in `out_dir/`):
  - `${project}.snp.indel.sv.vcf` - Concatenated VCF containing all variant types (before imputation)
  - `${project}.snp.indel.sv.impute.vcf.gz` - Imputed VCF containing all variant types
  - `${project}.snp.impute.vcf.gz` - Imputed SNP variants only
  - `${project}.indel.impute.vcf.gz` - Imputed INDEL variants only
  - `${project}.sv.impute.vcf.gz` - Imputed SV variants only

## Pipeline Processes

### 1. INDEX_REFERENCE
Indexes the reference genome using `samtools faidx` and creates sequence dictionary using Picard `CreateSequenceDictionary`.

### 2. UNIFIED_GENOTYPER_SNP
Genotypes known SNP sites using GATK UnifiedGenotyper in genotype-given-alleles mode (`-gt_mode GENOTYPE_GIVEN_ALLELES`). Uses interval lists to target specific marker positions.

### 3. UNIFIED_GENOTYPER_INDEL
Genotypes known INDEL sites using GATK UnifiedGenotyper in genotype-given-alleles mode. Uses interval lists to target specific marker positions.

### 4. GATK_SNP_FORMAT
Formats SNP VCF file, fills missing ALT alleles using `bcftools norm`, and assigns variant IDs using `assign_id.sh` script.

### 5. GATK_INDEL_FORMAT
Formats INDEL VCF file, fills missing ALT alleles using `bcftools norm`, and assigns variant IDs using `assign_id.sh` script.

### 6. DELLY_SV_GENOTYPE
Genotypes structural variants per sample using DELLY against known SV sites. This process runs in parallel across all samples.

### 7. BCFTOOLS_MERGE_GENOTYPE
Merges per-sample SV genotypes into a single multi-sample VCF using `bcftools merge`, then assigns variant IDs using `assign_id.sh` script.

### 8. CONCAT_VCF
Concatenates SNP, INDEL, and SV VCF files into a single combined VCF using `bcftools concat`.

### 9. BEAGLE_IMPUTATION
Performs genotype imputation using Beagle to fill missing genotypes across all variant types.

### 10. POP_SNP / POP_INDEL / POP_SV
Separates imputed variants by type using `bcftools view` with ID prefix filters (`SNP-`, `INDEL-`, `SV-`).

## Variant ID Format

Variants are assigned IDs with the following prefixes:
- **SNP variants**: `SNP-*` (e.g., `SNP-Chr1-12345-1`)
- **INDEL variants**: `INDEL-*` (e.g., `INDEL-Chr1-67890-1`)
- **SV variants**: `SV-*` (e.g., `SV-Chr1-111111-1`)

The ID assignment is performed by the `assign_id.sh` script, which ensures consistent ID formatting across all variant types.

## Important Notes

### Input File Requirements

- **BAM files must be indexed**: Ensure `.bai` index files exist for all BAM files. The pipeline will automatically check for index files.
- **Sites VCF files**: Must be sites-only VCF files (no sample genotype data). These files contain only variant positions and alleles.
- **SV sites file**: Must be in BCF format and must retain the INFO column from the original Delly-generated VCF. The INFO column contains critical structural variant annotations (e.g., SVTYPE, END, SVLEN) required for proper genotyping.

### SV INFO Column Preservation

**Critical**: The INFO column in SV sites BCF files is essential for proper genotyping. If the INFO column is missing or incomplete, SV variants will not be properly genotyped, although the pipeline will continue to run.

If your SV sites file has lost the INFO column (e.g., after Beagle imputation), you can restore it using `bcftools annotate`:

```bash
bcftools annotate \
    -a /path/to/original/delly/vcf/with/info/column.vcf.gz \
    -c INFO \
    -o sv_sites_with_info.bcf \
    sv_sites_without_info.bcf
```

### Memory Requirements

- **Beagle imputation**: Requires significant memory (default: 300 GB). Increase `--beagle_memory` if you encounter out-of-memory errors.
- **GATK UnifiedGenotyper**: Memory requirements depend on the number of samples and variant sites. Default is 100g, but may need adjustment for large cohorts.

### Parallel Execution

- The pipeline automatically parallelizes per-sample SV genotyping using DELLY
- GATK UnifiedGenotyper runs once per variant type (SNP and INDEL) across all samples

## Troubleshooting

### Common Issues

1. **Missing BAM index files**: Ensure all BAM files have corresponding `.bai` files in the same directory
2. **DELLY produces 0 variants**: 
   - Check that SV sites BCF matches the reference genome
   - Verify that SV sites BCF contains the INFO column
   - Ensure the reference genome used for SV sites matches the reference used for BAM alignment
3. **Memory errors**: 
   - Increase `--beagle_memory` for Beagle imputation errors
   - Increase `--gatk_memory` for GATK UnifiedGenotyper errors
4. **Path errors**: 
   - Ensure all software paths are absolute or accessible in PATH
   - Verify that `assign_id.sh` script is executable and accessible
5. **SV genotyping fails**: 
   - Verify SV sites BCF file format and INFO column presence
   - Check that reference genome matches between SV sites and BAM files

### Log Files

- Nextflow execution log: `.nextflow.log`
- Process-specific logs: Check the work directory for individual process logs
- DELLY per-sample logs: Available in the work directory for each sample

## Citation

If you use this pipeline, please cite:

- **GATK**: McKenna et al. (2010) The Genome Analysis Toolkit: a MapReduce framework for analyzing next-generation DNA sequencing data. *Genome Research* 20:1297-1303
- **DELLY**: Rausch et al. (2012) DELLY: structural variant discovery by integrated paired-end and split-read analysis. *Bioinformatics* 28:i333-i339
- **Beagle**: Browning et al. (2018) A one-penny imputed genome from next-generation reference panels. *American Journal of Human Genetics* 103:338-348
